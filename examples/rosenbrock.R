library(Rcpp)
library(ADinR)

#load the adinr module
adinr<-Rcpp::Module("adinr", PACKAGE="ADinR")

#helper functions
make_parameter_list<-function(length){
  l<-list()
  for(i in 1:length){
    l[[i]]<-adinr$parameter()
  }
  return(l)
}

make_variable_list<-function(length){
  l<-list()
  for(i in 1:length){
    l[[i]]<-adinr$variable()
  }
  return(l)
}

#expected x
expected_x<-c(-0.504559956550598 , -1.87552543258667 , -0.55537220954895 ,
              -0.926714798927307 , 1.43551480102539 , -0.563602585792542 ,
              -0.800858969688416 , 1.06141835021973 , 1.41244262123108 ,
              -0.17235328578949 , 0.940571297645569 , -1.62169390678406 ,
              -1.14694890403748 , 1.85938431072235 , 1.03234576892853 ,
              1.30644124984741 , -0.336784991264343 , 0.384362467765808 ,
              1.22398129272461 , 1.59092183208466 , -0.470255233764648 ,
              -1.67804074287415 , 0.515045937538147 , 1.00612594604492 ,
              -1.69828983879089 , -0.817079864501953 , 0.469246596336365 ,
              1.03600970935822 , 1.70826601696014 , -0.0993259286880492 ,
              0.274921333312988 , 0.969196937561035 , 1.46410465049744 ,
              1.67586408233643 , -1.81705840492249 , 0.0119124135971069 ,
              -0.612168609619141 , 1.41539787960052 , 1.25515843105316 ,
              -1.56741129302979 , 0.871164129257202 , -1.08433875751495 ,
              -1.74097714710236 , 1.78440661907196 , -1.40424058818817 ,
              0.602346905708313 , -1.33727131175995 , -1.96577685832977 ,
              0.0873015146255494 , -1.69460574913025)

#simulate observed data
y<-c(455.998935467595 , 1667.17536360375 , 154.979498300342 ,
     36.9721893459898 , 688.887519520229 , 127.550609143363 ,
     20.8867271305619 , 8.1738630222189 , 469.909603242981 ,
     84.3420340996098 , 628.191723629795 , 1433.3253411726 ,
     34.1912971724492 , 588.783700846825 , 5.79486196951154 ,
     417.713265466047 , 9.12775238152566 , 116.209724029634 ,
     0.911196226309476 , 901.121860120671 , 362.850394120845 ,
     536.528368967 , 55.1215902948359 , 734.724028969069 ,
     1377.219427269 , 7.23696032213503 , 66.837492593309 ,
     40.3174341327859 , 911.031489281162 , 8.23396954743111 ,
     80.380551291558 , 27.5384589011655 , 22.0933090903731 ,
     2140.05474109562 , 1090.20687482882 , 38.4687337829158 ,
     110.893803931448 , 56.1517910007931 , 987.805648455477 ,
     258.00878667759 , 339.779441883628 , 855.097842720502 ,
     162.912817169599 , 2105.90863640157 , 193.345647856582 ,
     289.189785086235 , 1414.76805951998 , 1435.35146558259 ,
     290.590797832627,0.0)
#create noise
#y<-y*runif(length(y), min=0.9, max = 1.1)

nobs <- length(y)

x<-make_parameter_list(nobs)

#start recording
adinr$set_recording(TRUE)

pred_y <- make_variable_list(nobs)
norm2<-adinr$variable()

  for(i in 1:(nobs-1)){
      pred_y[[i]] <- 100*pow(x[[i+1]]-pow(x[[i]],2),2) + pow(x[[i]]-1,2)
     norm2<-norm2 + (pred_y[[i]]-y[i])*(pred_y[[i]]-y[i])
  }

f<- (nobs*0.5)*log(norm2)

cntrl<-list()
cntrl["max_iterations"]<-5000
results<-adinr$minimize(cntrl)

for(i in 1:(nobs)){
    cat(paste(paste(paste(pred_y[[i]]$value(), "\t"), y[i])),"\n")
}

predicted <- c(1:nobs)
for(i in 1:nobs){
  predicted[i]<-pred_y[[i]]$value()
}

print(results)
#plot.new()
#plot(x=expected_x, y=y)
#lines(expected_x,predicted)

